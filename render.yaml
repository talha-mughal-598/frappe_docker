services:
  # ---------------------------------------------------------------------------
  # Configurator – one–time configuration job.
  # (Set autoDeploy to false so it does not run automatically; trigger it manually
  #  once you’ve deployed the other services.)
  - type: worker
    name: configurator
    autoDeploy: false
    env: docker
    image: frappe/erpnext:v15.50.0
    # Run all configuration commands in one bash shell.
    startCommand: >
      bash -c "ls -1 apps > sites/apps.txt;
      bench set-config -g db_host $DB_HOST;
      bench set-config -gp db_port $DB_PORT;
      bench set-config -g redis_cache 'redis://$REDIS_CACHE';
      bench set-config -g redis_queue 'redis://$REDIS_QUEUE';
      bench set-config -g redis_socketio 'redis://$REDIS_QUEUE';
      bench set-config -gp socketio_port $SOCKETIO_PORT"
    envVars:
      - key: DB_HOST
        value: ${DB_HOST}
      - key: DB_PORT
        value: ${DB_PORT}
      - key: REDIS_CACHE
        value: ${REDIS_CACHE}
      - key: REDIS_QUEUE
        value: ${REDIS_QUEUE}
      - key: SOCKETIO_PORT
        value: "9000"
    disk:
      mountPath: /home/frappe/frappe-bench/sites

  # ---------------------------------------------------------------------------
  # Frontend – public web service (runs nginx).
  - type: web
    name: frontend
    env: docker
    image: frappe/erpnext:v15.50.0
    startCommand: "nginx-entrypoint.sh"
    envVars:
      - key: BACKEND
        value: "backend:8000"
      - key: SOCKETIO
        value: "websocket:9000"
      - key: FRAPPE_SITE_NAME_HEADER
        value: "${FRAPPE_SITE_NAME_HEADER:-$host}"
      - key: UPSTREAM_REAL_IP_ADDRESS
        value: "${UPSTREAM_REAL_IP_ADDRESS:-127.0.0.1}"
      - key: UPSTREAM_REAL_IP_HEADER
        value: "${UPSTREAM_REAL_IP_HEADER:-X-Forwarded-For}"
      - key: UPSTREAM_REAL_IP_RECURSIVE
        value: "${UPSTREAM_REAL_IP_RECURSIVE:-off}"
      - key: PROXY_READ_TIMEOUT
        value: "${PROXY_READ_TIMEOUT:-120}"
      - key: CLIENT_MAX_BODY_SIZE
        value: "${CLIENT_MAX_BODY_SIZE:-50m}"
    disk:
      mountPath: /home/frappe/frappe-bench/sites

  # ---------------------------------------------------------------------------
  # Backend – internal web service.
  # (By marking it “private” the service is not exposed to the public internet.)
  - type: web
    name: backend
    env: docker
    image: frappe/erpnext:v15.50.0
    # (No startCommand here means the image’s default command is used.)
    disk:
      mountPath: /home/frappe/frappe-bench/sites

  # ---------------------------------------------------------------------------
  # Websocket – internal service running the socket.io process.
  - type: web
    name: websocket
    env: docker
    image: frappe/erpnext:v15.50.0
    startCommand: "node /home/frappe/frappe-bench/apps/frappe/socketio.js"
    disk:
      mountPath: /home/frappe/frappe-bench/sites

  # ---------------------------------------------------------------------------
  # Queue worker (short) – background worker for short/fast queues.
  - type: worker
    name: queue-short
    env: docker
    image: frappe/erpnext:v15.50.0
    startCommand: "bench worker --queue short,default"
    disk:
      mountPath: /home/frappe/frappe-bench/sites

  # ---------------------------------------------------------------------------
  # Queue worker (long) – background worker for long queues.
  - type: worker
    name: queue-long
    env: docker
    image: frappe/erpnext:v15.50.0
    startCommand: "bench worker --queue long,default,short"
    disk:
      mountPath: /home/frappe/frappe-bench/sites

  # ---------------------------------------------------------------------------
  # Scheduler – background service to run scheduled tasks.
  - type: worker
    name: scheduler
    env: docker
    image: frappe/erpnext:v15.50.0
    startCommand: "bench schedule"
    disk:
      mountPath: /home/frappe/frappe-bench/sites
